

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>calculators.processorRemoteReference &mdash; Resistics 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Resistics
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/advanced.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maindoc/cookbook.html">Cookbook</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Resistics</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>calculators.processorRemoteReference</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for calculators.processorRemoteReference</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">interp</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span>

<span class="c1"># import from package</span>
<span class="kn">from</span> <span class="nn">resistics.calculators.processorSingleSite</span> <span class="k">import</span> <span class="n">ProcessorSingleSite</span>
<span class="kn">from</span> <span class="nn">resistics.utilities.utilsSmooth</span> <span class="k">import</span> <span class="n">smooth1d</span>
<span class="kn">from</span> <span class="nn">resistics.utilities.utilsRobust</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">chatterjeeMachler</span><span class="p">,</span>
    <span class="n">sampleMAD0</span><span class="p">,</span>
    <span class="n">hermitianTranspose</span><span class="p">,</span>
    <span class="n">olsModel</span><span class="p">,</span>
    <span class="n">mmestimateModel</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="ProcessorRemoteReference"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference">[docs]</a><span class="k">class</span> <span class="nc">ProcessorRemoteReference</span><span class="p">(</span><span class="n">ProcessorSingleSite</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform remote reference processing of magnetotelluric data</span>

<span class="sd">    Remote reference processing uses a different equation for spectral power than the single site processor. The equation that the processor uses is:</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    winSelector : WindowSelect</span>
<span class="sd">        A window selector object which defines which windows to use in the linear model</span>
<span class="sd">    decParams : DecimationParameters</span>
<span class="sd">        DecimationParameters object with information about the decimation scheme</span>
<span class="sd">    winParams : WindowParameters</span>
<span class="sd">        WindowParameters object with information about the windowing</span>
<span class="sd">    outpath : str </span>
<span class="sd">        Location to put the calculated transfer functions (Edi files)</span>
<span class="sd">    inSite : str </span>
<span class="sd">        The site to use for the input channels </span>
<span class="sd">    inChannels: List[str] ([&quot;Hx&quot;, &quot;Hy&quot;])</span>
<span class="sd">        List of hannels to use as input channels for the linear system</span>
<span class="sd">    inSize : int </span>
<span class="sd">        Number of input channels</span>
<span class="sd">    outSite : str </span>
<span class="sd">        The site to use for the output channels</span>
<span class="sd">    outChannels : List[str] ([&quot;Ex&quot;, &quot;Ey&quot;])</span>
<span class="sd">        List of channels to use as output channels for the linear system</span>
<span class="sd">    outSize : int</span>
<span class="sd">        Number of output channels</span>
<span class="sd">    allChannels : List[str] </span>
<span class="sd">        inChannels and outChannels combined into a single list</span>
<span class="sd">    crossChannels : List[str] </span>
<span class="sd">        </span>
<span class="sd">    intercept : bool (default False)</span>
<span class="sd">        Flag for including an intercept (static) term in the linear system</span>
<span class="sd">    method : str (options, &quot;ols&quot;, &quot;cm&quot;) </span>
<span class="sd">        String for describing what solution method to use</span>
<span class="sd">    win : str (default hanning)</span>
<span class="sd">        Window function to use in robust solution</span>
<span class="sd">    winSmooth : int (default -1)</span>
<span class="sd">        The size of the window smoother. If -1, this will be autocalculated based on data size</span>
<span class="sd">    postpend : str (default &quot;&quot;)</span>
<span class="sd">        String to postpend to the output filename to help file management</span>
<span class="sd">    evalFreq : List[float] or np.ndarray</span>
<span class="sd">        The evaluation frequencies</span>
<span class="sd">    impedances : List</span>

<span class="sd">    variances : List</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __init__(proj, maskData)</span>
<span class="sd">        Initialise with a Project instance and MaskData instance</span>


<span class="sd">    printList()</span>
<span class="sd">        Class status returned as list of strings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">winSelector</span><span class="p">,</span> <span class="n">outpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span> <span class="o">=</span> <span class="n">winSelector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decParams</span> <span class="o">=</span> <span class="n">winSelector</span><span class="o">.</span><span class="n">decParams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winParams</span> <span class="o">=</span> <span class="n">winSelector</span><span class="o">.</span><span class="n">winParams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">outpath</span>

        <span class="c1"># default parameters for user options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inSite</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inChannels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outSite</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outChannels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># smoothing options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hanning&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winSmooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># intercept options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># output filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postpend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># evaluation frequency data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evalFreq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impedances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variances</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ProcessorRemoteReference.setRemote"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.setRemote">[docs]</a>    <span class="k">def</span> <span class="nf">setRemote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remoteSite</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remoteChannels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set information about input site and channels</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remoteSite : str</span>
<span class="sd">            Site to use for input channel data</span>
<span class="sd">        remoteChannels : List[str]</span>
<span class="sd">            Channels to use as the remote reference in the linear system</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span> <span class="o">=</span> <span class="n">remoteSite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span> <span class="o">=</span> <span class="n">remoteChannels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remoteChannels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span>
            <span class="s2">&quot;Remote reference set with site </span><span class="si">{}</span><span class="s2"> and channels </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorRemoteReference.process"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process spectra data</span>

<span class="sd">        The processing sequence is as below:</span>

<span class="sd">        For each decimation level</span>
<span class="sd">            Get shared (unmasked) windows for all relevant sites (inSite and outSite)</span>
<span class="sd">            For shared unmasked windows</span>
<span class="sd">                Calculate out the spectral power data</span>
<span class="sd">                Interpolate calculated spectral power data to the evaluation frequencies for the decimation level </span>
<span class="sd">            For each evaluation frequency</span>
<span class="sd">                Do the robust processing to calculate the transfer function at that evaluation frequency</span>


<span class="sd">        NOTES</span>
<span class="sd">        -----</span>
<span class="sd">        The spectral power data is smoothed as this tends to improve results. The smoothing can be changed by setting the smoothing parameters. This method is still subject to change in the future as it is an area of active work</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">numLevels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decParams</span><span class="o">.</span><span class="n">numLevels</span>
        <span class="n">dataChans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inChannels</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outChannels</span>
        <span class="k">for</span> <span class="n">iDec</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numLevels</span><span class="p">):</span>
            <span class="c1"># print out some info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span><span class="s2">&quot;Processing decimation level </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iDec</span><span class="p">))</span>

            <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">decParams</span><span class="o">.</span><span class="n">getSampleFreqLevel</span><span class="p">(</span><span class="n">iDec</span><span class="p">)</span>
            <span class="c1"># get the number of all shared windows and the number of unmasked windows</span>
            <span class="c1"># unmasked windows are ones that will actually be used in the calculation</span>
            <span class="n">numWindows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getNumSharedWindows</span><span class="p">(</span><span class="n">iDec</span><span class="p">)</span>
            <span class="n">unmaskedWindows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getUnmaskedWindowsLevel</span><span class="p">(</span><span class="n">iDec</span><span class="p">)</span>
            <span class="n">numUnmasked</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmaskedWindows</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span>
                <span class="s2">&quot;Total shared windows for decimation level = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numWindows</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span>
                <span class="s2">&quot;Total unmasked windows for decimation level = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numUnmasked</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">numUnmasked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span>
                    <span class="s2">&quot;No unmasked windows found at this decimation level (</span><span class="si">{:d}</span><span class="s2">), continuing to next level&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">iDec</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">continue</span>  <span class="c1"># continue to next decimation level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> windows will be processed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numUnmasked</span><span class="p">))</span>

            <span class="c1"># get the evaluation frequencies</span>
            <span class="n">evalFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decParams</span><span class="o">.</span><span class="n">getEvalFrequenciesForLevel</span><span class="p">(</span><span class="n">iDec</span><span class="p">)</span>
            <span class="c1"># set some variables</span>
            <span class="n">totalChans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span>
            <span class="n">numEvalFreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evalFreq</span><span class="p">)</span>
            <span class="n">dataSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getDataSize</span><span class="p">(</span><span class="n">iDec</span><span class="p">)</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">)</span>
            <span class="c1"># get the window smoothing params</span>
            <span class="n">smoothLen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWindowSmooth</span><span class="p">(</span><span class="n">datasize</span><span class="o">=</span><span class="n">dataSize</span><span class="p">)</span>

            <span class="c1"># create the data array</span>
            <span class="c1"># for each evaluation frequency</span>
            <span class="c1"># keep the spectral power information for all windows</span>
            <span class="n">evalFreqData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">numEvalFreq</span><span class="p">,</span> <span class="n">numWindows</span><span class="p">,</span> <span class="n">totalChans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># an array for the in and out channels fourier data</span>
            <span class="n">winDataArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">totalChans</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>
            <span class="c1"># an array for the remote reference fourier data</span>
            <span class="n">winRemoteArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span>
            <span class="p">)</span>
            <span class="c1"># an array for the power spectra data</span>
            <span class="n">winSpectraMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">totalChans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span>
            <span class="p">)</span>

            <span class="c1"># loop over shared windows</span>
            <span class="n">localWin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">global2local</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">iWin</span> <span class="ow">in</span> <span class="n">unmaskedWindows</span><span class="p">:</span>
                <span class="c1"># do the local to global map</span>
                <span class="n">global2local</span><span class="p">[</span><span class="n">iWin</span><span class="p">]</span> <span class="o">=</span> <span class="n">localWin</span>

                <span class="c1"># get the window for the input site</span>
                <span class="n">inSF</span><span class="p">,</span> <span class="n">inReader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getSpecReaderForWindow</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inSite</span><span class="p">,</span> <span class="n">iDec</span><span class="p">,</span> <span class="n">iWin</span>
                <span class="p">)</span>
                <span class="n">inData</span> <span class="o">=</span> <span class="n">inReader</span><span class="o">.</span><span class="n">readBinaryWindowGlobal</span><span class="p">(</span><span class="n">iWin</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="c1"># get the window and channels for the output site</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSite</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSite</span><span class="p">:</span>
                    <span class="n">outSF</span><span class="p">,</span> <span class="n">outReader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getSpecReaderForWindow</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outSite</span><span class="p">,</span> <span class="n">iDec</span><span class="p">,</span> <span class="n">iWin</span>
                    <span class="p">)</span>
                    <span class="n">outData</span> <span class="o">=</span> <span class="n">outReader</span><span class="o">.</span><span class="n">readBinaryWindowGlobal</span><span class="p">(</span><span class="n">iWin</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outData</span> <span class="o">=</span> <span class="n">inData</span>

                <span class="c1"># now get the remote reference data - assume this does not equal input or output</span>
                <span class="n">remoteSF</span><span class="p">,</span> <span class="n">remoteReader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getSpecReaderForWindow</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span><span class="p">,</span> <span class="n">iDec</span><span class="p">,</span> <span class="n">iWin</span>
                <span class="p">)</span>
                <span class="n">remoteData</span> <span class="o">=</span> <span class="n">remoteReader</span><span class="o">.</span><span class="n">readBinaryWindowGlobal</span><span class="p">(</span><span class="n">iWin</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

                <span class="c1"># get data into the right part of the arrays</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">):</span>
                    <span class="n">winDataArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inChannels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">):</span>
                    <span class="n">winDataArray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inSize</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outChannels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">):</span>
                    <span class="n">winRemoteArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">remoteData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

                <span class="c1"># and now can fill the parts of the matrix</span>
                <span class="c1"># recall, smooth the power spectra</span>
                <span class="k">for</span> <span class="n">iD</span><span class="p">,</span> <span class="n">dataChan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataChans</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">iR</span><span class="p">,</span> <span class="n">remoteChan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span><span class="p">):</span>
                        <span class="c1"># calculate each one, cannot use complex symmetry here</span>
                        <span class="c1"># cannot use conjugate symmetry like with the single site processor</span>
                        <span class="n">winSpectraMatrix</span><span class="p">[</span><span class="n">iD</span><span class="p">,</span> <span class="n">iR</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth1d</span><span class="p">(</span>
                            <span class="n">winDataArray</span><span class="p">[</span><span class="n">iD</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">winRemoteArray</span><span class="p">[</span><span class="n">iR</span><span class="p">]),</span>
                            <span class="n">smoothLen</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="c1"># after running through all windows, calculate evaluation frequencies</span>
                <span class="c1"># calculate frequency array</span>
                <span class="n">evalFreqData</span><span class="p">[:,</span> <span class="n">localWin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcEvalFrequencyData</span><span class="p">(</span>
                    <span class="n">freq</span><span class="p">,</span> <span class="n">evalFreq</span><span class="p">,</span> <span class="n">winSpectraMatrix</span>
                <span class="p">)</span>

                <span class="c1"># increment local window</span>
                <span class="n">localWin</span> <span class="o">=</span> <span class="n">localWin</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># now all the data has been collected</span>
            <span class="c1"># for each evaluation frequency, do the robust processing</span>
            <span class="c1"># and get the evaluation frequency data</span>
            <span class="k">for</span> <span class="n">eIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numEvalFreq</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span>
                    <span class="s2">&quot;Processing evaluation frequency = </span><span class="si">{:.6f}</span><span class="s2"> [Hz], period = </span><span class="si">{:.6f}</span><span class="s2"> [s]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">evalFreq</span><span class="p">[</span><span class="n">eIdx</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">evalFreq</span><span class="p">[</span><span class="n">eIdx</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># get the constrained windows for the evaluation frequency</span>
                <span class="n">evalFreqWindows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">getWindowsForFreq</span><span class="p">(</span><span class="n">iDec</span><span class="p">,</span> <span class="n">eIdx</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evalFreqWindows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># no windows meet constraints</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span><span class="s2">&quot;No windows found - possibly due to masking&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">localWinIndices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">iW</span> <span class="ow">in</span> <span class="n">evalFreqWindows</span><span class="p">:</span>
                    <span class="n">localWinIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global2local</span><span class="p">[</span><span class="n">iW</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">printText</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2"> windows will be solved for&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">localWinIndices</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="c1"># restrict processing to data that meets constraints for this evaluation frequency</span>
                <span class="c1"># add to class vars</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evalFreq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evalFreq</span><span class="p">[</span><span class="n">eIdx</span><span class="p">])</span>
                <span class="c1"># use process reduced - only the input channels from the remote reference</span>
                <span class="n">numSolveWindows</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepareLinearEqn</span><span class="p">(</span>
                    <span class="n">evalFreqData</span><span class="p">[</span><span class="n">eIdx</span><span class="p">,</span> <span class="n">localWinIndices</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robustProcess</span><span class="p">(</span><span class="n">numSolveWindows</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impedances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalFreq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printWarning</span><span class="p">(</span>
                <span class="s2">&quot;No data was found at any decimation level for insite </span><span class="si">{}</span><span class="s2">, outsite </span><span class="si">{}</span><span class="s2">, remotesite </span><span class="si">{}</span><span class="s2"> and specdir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inSite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">specdir</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># write out all the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeTF</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">winSelector</span><span class="o">.</span><span class="n">specdir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postpend</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evalFreq</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impedances</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variances</span><span class="p">,</span>
            <span class="n">remotesite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span><span class="p">,</span>
            <span class="n">remotechans</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ProcessorRemoteReference.checkRemote"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.checkRemote">[docs]</a>    <span class="k">def</span> <span class="nf">checkRemote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">check</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">check</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inChannels</span>
        <span class="k">return</span> <span class="n">check</span></div>

    <span class="c1"># PREPARE ROUTINES</span>
<div class="viewcode-block" id="ProcessorRemoteReference.prepareLinearEqn"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.prepareLinearEqn">[docs]</a>    <span class="k">def</span> <span class="nf">prepareLinearEqn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># prepare observations and regressors for linear processing</span>
        <span class="n">numWindows</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">numWindows</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkForBadValues</span><span class="p">(</span><span class="n">numWindows</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="c1"># for each output variable, have ninput regressor variables</span>
        <span class="c1"># let&#39;s construct our arrays</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span> <span class="o">*</span> <span class="n">numWindows</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span>
        <span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span> <span class="o">*</span> <span class="n">numWindows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">iW</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numWindows</span><span class="p">):</span>
            <span class="n">iOffset</span> <span class="o">=</span> <span class="n">iW</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">):</span>
                    <span class="c1"># this is the observation row where,i is the observed output</span>
                    <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">iOffset</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">iW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">):</span>
                        <span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">iOffset</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">iW</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">numWindows</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reg</span></div>

    <span class="c1"># SOLVER ROUTINES</span>
<div class="viewcode-block" id="ProcessorRemoteReference.robustProcess"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.robustProcess">[docs]</a>    <span class="k">def</span> <span class="nf">robustProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numWindows</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
        <span class="c1"># do the chatterjeeMachlerMod robust processing for a single evaluation frequency</span>
        <span class="c1"># create array for output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>
        <span class="n">varOutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="c1"># solve</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">):</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">predictors</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="c1"># save the output</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">resids</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">chatterjeeMachler</span><span class="p">(</span>
                <span class="n">predictors</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept</span>
            <span class="p">)</span>
            <span class="c1"># out, resids, scale, weights = mmestimateModel(predictors, observation, intercept=self.intercept)</span>

            <span class="c1"># now take the weights, apply to the observations and predictors, stack the appropriate rows and test</span>
            <span class="n">observation2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>
            <span class="n">predictors2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">iChan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">):</span>
                <span class="c1"># now need to have my indexing array</span>
                <span class="n">indexArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">iChan</span><span class="p">,</span> <span class="n">numWindows</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span>
                <span class="p">)</span>
                <span class="n">weightsLim</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">indexArray</span><span class="p">]</span>
                <span class="c1"># weightsLim = weightsLim/np.sum(weightsLim) # normalise weights to 1</span>
                <span class="n">observation2</span><span class="p">[</span><span class="n">iChan</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indexArray</span><span class="p">]</span> <span class="o">*</span> <span class="n">weightsLim</span><span class="p">)</span> <span class="o">/</span> <span class="n">numWindows</span>
                <span class="p">)</span>
                <span class="c1"># now for the regressors</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">):</span>
                    <span class="n">predictors2</span><span class="p">[</span><span class="n">iChan</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indexArray</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">weightsLim</span><span class="p">)</span> <span class="o">/</span> <span class="n">numWindows</span>
                    <span class="p">)</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">resids</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">chatterjeeMachler</span><span class="p">(</span>
                <span class="n">predictors2</span><span class="p">,</span> <span class="n">observation2</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept</span>
            <span class="p">)</span>
            <span class="c1"># out, resids, scale, weights = mmestimateModel(predictors2, observation2, intercept=self.intercept)</span>

            <span class="c1"># now calculate out the varainces - have the solution out, have the weights</span>
            <span class="c1"># recalculate out the residuals with the final solution</span>
            <span class="c1"># calculate standard deviation of residuals</span>
            <span class="c1"># and then use chatterjee machler formula to estimate variances</span>
            <span class="c1"># this needs work - better to use an empirical bootstrap method, but this will do for now</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">observation</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">predictors</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">sampleMAD0</span><span class="p">(</span>
                <span class="n">resids</span>
            <span class="p">)</span>  <span class="c1"># some measure of standard deviation, rather than using the standard deviation</span>
            <span class="n">residsVar</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">varPred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">hermitianTranspose</span><span class="p">(</span><span class="n">predictors</span><span class="p">),</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">predictors</span><span class="p">)</span>
            <span class="n">varPred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">varPred</span><span class="p">)</span>  <span class="c1"># this is a pxp matrix</span>
            <span class="n">varOut</span> <span class="o">=</span> <span class="mf">1.91472</span> <span class="o">*</span> <span class="n">residsVar</span> <span class="o">*</span> <span class="n">varPred</span>
            <span class="n">varOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">varOut</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>  <span class="c1"># this should be a real number</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">varOutput</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">varOut</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">varOutput</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">varOut</span>

        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">varOutput</span></div>

<div class="viewcode-block" id="ProcessorRemoteReference.olsProcess"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.olsProcess">[docs]</a>    <span class="k">def</span> <span class="nf">olsProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numWindows</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
        <span class="c1"># ordinary least squares solution</span>
        <span class="c1"># create array for output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>
        <span class="c1"># solve</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">):</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">predictors</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="c1"># save the output</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">resids</span><span class="p">,</span> <span class="n">squareResid</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">olsModel</span><span class="p">(</span>
                <span class="n">predictors</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ProcessorRemoteReference.stackedProcess"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.stackedProcess">[docs]</a>    <span class="k">def</span> <span class="nf">stackedProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># then do various sums</span>
        <span class="n">numWindows</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">numWindows</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkForBadValues</span><span class="p">(</span><span class="n">numWindows</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="c1"># unweighted sum (i.e. normal solution)</span>
        <span class="n">unWeightedSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">unWeightedSum</span> <span class="o">=</span> <span class="n">unWeightedSum</span> <span class="o">/</span> <span class="n">numWindows</span>
        <span class="c1"># for each output variable, have ninput regressor variables</span>
        <span class="c1"># let&#39;s construct our arrays</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteSize</span><span class="p">):</span>
                <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">unWeightedSum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inSize</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">):</span>
                    <span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">unWeightedSum</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="c1"># create array for output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outSize</span><span class="p">):</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">predictors</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="c1"># save the output</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">resids</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">mmestimateModel</span><span class="p">(</span>
                <span class="n">predictors</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ProcessorRemoteReference.printList"><a class="viewcode-back" href="../../calculators.processorRemoteReference.html#calculators.processorRemoteReference.ProcessorRemoteReference.printList">[docs]</a>    <span class="k">def</span> <span class="nf">printList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Class information as a list of strings</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : list</span>
<span class="sd">            List of strings with information</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">textLst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">textLst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;In Site = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inSite</span><span class="p">))</span>
        <span class="n">textLst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;In Channels = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inChannels</span><span class="p">))</span>
        <span class="n">textLst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Out Site = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outSite</span><span class="p">))</span>
        <span class="n">textLst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Out Channels = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outChannels</span><span class="p">))</span>
        <span class="n">textLst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Remote Site = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteSite</span><span class="p">))</span>
        <span class="n">textLst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Remote Channels = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteChannels</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">textLst</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Neeraj Shah

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>